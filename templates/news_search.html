<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>📰 네이버 뉴스검색기</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .input-long { width: 100%; font-size: 1.1em; }
        textarea { width: 100%; height: 220px; font-size: 1em; }
        .result-row { margin-bottom: 8px; }
        .toolbar { margin: 1em 0; }
        .btn { padding: 4px 16px; margin-right: 10px; }
        .checkbox-list { margin-bottom: 1em; }
    </style>
    <script>
        // 결과 선택/해제/복사/주소변환 JS
        function toggleAll(check) {
            document.querySelectorAll('.row-checkbox').forEach(e => {e.checked = check;});
            updateText();
        }
        function updateText() {
            let lines = [];
            document.querySelectorAll('.row-checkbox').forEach((cb, i) => {
                if (cb.checked) {
                    let line = document.getElementById('resultline_' + i).innerText;
                    lines.push(line);
                }
            });
            document.getElementById('final_textarea').value = lines.join('\n\n');
        }
        async function copySelected() {
            updateText();
            const text = document.getElementById('final_textarea').value;
            await navigator.clipboard.writeText(text);
            alert('복사됨!');
        }
        async function shortenUrls() {
            let urls = [];
            document.querySelectorAll('.row-checkbox').forEach((cb, i) => {
                if (cb.checked) {
                    let url = cb.value;
                    urls.push(url);
                }
            });
            if (urls.length == 0) return;
            document.getElementById('shortenBtn').innerText = "주소변환중...";
            const resp = await fetch('/shorten', {
                method: 'POST',
                body: new URLSearchParams(urls.map(u => ['urls', u]))
            });
            const data = await resp.json();
            document.querySelectorAll('.row-checkbox').forEach((cb, i) => {
                if (cb.checked) {
                    let line = document.getElementById('resultline_' + i).innerText;
                    let old_url = cb.value;
                    let new_url = data.shortened.shift();
                    line = line.replace(old_url, new_url);
                    document.getElementById('resultline_' + i).innerText = line;
                }
            });
            updateText();
            document.getElementById('shortenBtn').innerText = "선택 주소 단축변환";
        }
    </script>
</head>
<body>
    <h2>📰 네이버 뉴스검색기</h2>
    <form method="post">
        <input type="hidden" name="search_mode" value="major"/>
        <div>
            <label for="keywords">🔍 키워드 입력 (쉼표 구분):</label>
            <input class="input-long" type="text" id="keywords" name="keywords" value="{{request.form.keywords if request.method=='POST' else default_keywords}}" placeholder="{{default_keywords}}" />
        </div>
        <div class="checkbox-list">
            <label><input type="checkbox" name="checked_two_keywords" {% if checked_two_keywords %}checked{% endif %}> 2개 이상 키워드 포함 기사만 보기</label>
        </div>
        <button class="btn" type="submit">🔍 뉴스 검색</button>
    </form>

    {% if msg %}
        <div style="margin-top:1em; color:#777;">{{msg}}</div>
    {% endif %}

    {% if final_results %}
    <div class="toolbar">
        <button class="btn" type="button" onclick="toggleAll(true)">✅ 전체 선택</button>
        <button class="btn" type="button" onclick="toggleAll(false)">❌ 전체 해제</button>
        <button class="btn" type="button" onclick="copySelected()">📋 선택 복사</button>
    </div>
    <div>
        {% for row in final_results %}
        <div class="result-row">
            <input class="row-checkbox" type="checkbox" value="{{row.url}}" checked onchange="updateText()"/>
            <span id="resultline_{{loop.index0}}">
                ■ {{row.title}} ({{row.press}}) | {{row.pubdate.strftime('%Y-%m-%d %H:%M')}} | 키워드: {{row.matched|join(', ')}}<br>
                {{row.url}}
            </span>
        </div>
        {% endfor %}
    </div>
    <textarea id="final_textarea" readonly>
{% for row in final_results %}
■ {{row.title}} ({{row.press}}) | {{row.pubdate.strftime('%Y-%m-%d %H:%M')}} | 키워드: {{row.matched|join(', ')}}
{{row.url}}
{% endfor %}
    </textarea>
    <div>
        <button class="btn" id="shortenBtn" type="button" onclick="shortenUrls()">선택 주소 단축변환</button>
    </div>
    {% endif %}
</body>
</html>
