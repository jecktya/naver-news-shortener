<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“° ë‰´ìŠ¤ê²€ìƒ‰ê¸° (FastAPI ë²„ì „)</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background:#fcfcfc; margin:40px;}
        input[type=text], textarea { font-size:1.1em; padding:4px; border:1px solid #ccc; border-radius:5px;}
        .msg { color:#4287f5; font-size:1.08em; margin-bottom:10px;}
        .checkbox { margin-right:5px; }
        .btn { font-size:1em; padding:3px 10px; border-radius:4px; border:1px solid #bbb; margin:2px 3px; background:#e7e7ef; cursor:pointer;}
        .btn-selected { background:#4287f5; color:#fff;}
        .copytxt { width:100%; min-height:120px; font-size:1.05em; margin-top:10px; }
        .small { font-size:0.95em; color:gray;}
    </style>
    <script>
    // ì „ì²´ ì„ íƒ/í•´ì œ, ì„ íƒ ë³µì‚¬ js
    function selectAll(val) {
        let cbs = document.querySelectorAll('input[name="selected_urls"]');
        cbs.forEach(cb => {cb.checked = val;});
        updateCopyArea();
    }
    function updateCopyArea() {
        let lines = [];
        document.querySelectorAll('input[name="selected_urls"]:checked').forEach(cb => {
            let idx = cb.value;
            let title = document.getElementById("title_" + idx).textContent;
            let press = document.getElementById("press_" + idx).textContent;
            let url = document.getElementById("url_" + idx).textContent;
            lines.push(`[${press}] ${title}\n${url}`);
        });
        document.getElementById("copy_area").value = lines.join("\n\n");
    }
    function copyText() {
        let ta = document.getElementById("copy_area");
        ta.select(); document.execCommand("copy");
        alert("ë³µì‚¬ ì™„ë£Œ!");
    }
    async function convertShortUrls() {
        let checked = [];
        document.querySelectorAll('input[name="selected_urls"]:checked').forEach(cb => {
            let idx = cb.value;
            let url = document.getElementById("url_" + idx).textContent;
            if(url.startsWith("https://n.news.naver.com/")) checked.push(url);
        });
        if(checked.length === 0){
            alert("ë³€í™˜í•  ë„¤ì´ë²„ë‰´ìŠ¤ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        document.getElementById("shorten_btn").disabled = true;
        document.getElementById("shorten_btn").textContent = "ë³€í™˜ì¤‘...";
        let resp = await fetch("/shorten", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({"urls": checked})
        });
        let data = await resp.json();
        let result = data.result;
        let fail = data.fail;
        // ì£¼ì†Œ ë³€í™˜
        let lines = [];
        let fail_lines = [];
        document.querySelectorAll('input[name="selected_urls"]:checked').forEach(cb => {
            let idx = cb.value;
            let title = document.getElementById("title_" + idx).textContent;
            let press = document.getElementById("press_" + idx).textContent;
            let url = document.getElementById("url_" + idx).textContent;
            let replaced_url = result[url] ? result[url] : url;
            lines.push(`[${press}] ${title}\n${replaced_url}`);
            if(fail[url]){
                fail_lines.push(`${title}: ${fail[url]}`);
            }
        });
        document.getElementById("copy_area").value = lines.join("\n\n");
        document.getElementById("fail_area").innerHTML = fail_lines.length > 0 ? "<b>ğŸ”´ ë³€í™˜ ì‹¤íŒ¨:</b><br>" + fail_lines.join("<br>") : "";
        document.getElementById("shorten_btn").disabled = false;
        document.getElementById("shorten_btn").textContent = "ì£¼ì†Œë³€í™˜";
    }
    window.onload = function(){updateCopyArea();};
    </script>
</head>
<body>
    <h2>ğŸ“° ë‰´ìŠ¤ê²€ìƒ‰ê¸° (FastAPI+Playwright)</h2>
    <form method="post">
        <label>í‚¤ì›Œë“œ ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„):</label><br>
        <input type="text" name="keywords" style="width:98%;" value="{{default_keywords}}" />
        <span class="small">ì˜ˆ: ìœ¡êµ°, êµ­ë°©, ì™¸êµ, ì‹ ë³‘, êµìœ¡ëŒ€ ... (ìˆ˜ì •/ì¶”ê°€/ì‚­ì œ ììœ )</span><br>
        <input type="checkbox" name="checked_two_keywords" value="on" {% if checked_two_keywords %}checked{% endif %}> 2ê°œ ì´ìƒ í‚¤ì›Œë“œ í¬í•¨ë§Œ ë³´ê¸°
        &nbsp;&nbsp;
        <label>ê²€ìƒ‰ ëŒ€ìƒ:</label>
        <input type="radio" name="search_mode" value="major" {% if search_mode == "major" %}checked{% endif %}>ì£¼ìš”ì–¸ë¡ ì‚¬ë§Œ
        <input type="radio" name="search_mode" value="all" {% if search_mode == "all" %}checked{% endif %}>ì „ì²´
        &nbsp;&nbsp;
        <button type="submit" class="btn">ğŸ” ë‰´ìŠ¤ ê²€ìƒ‰</button>
    </form>
    {% if msg %}
    <div class="msg">{{msg}}</div>
    {% endif %}
    {% if final_results %}
    <div style="margin:12px 0;">
        <button type="button" class="btn" onclick="selectAll(true)">âœ… ì „ì²´ ì„ íƒ</button>
        <button type="button" class="btn" onclick="selectAll(false)">âŒ ì „ì²´ í•´ì œ</button>
        <button type="button" class="btn" onclick="copyText()">ğŸ“‹ ì„ íƒ ë³µì‚¬</button>
    </div>
    <form>
    <table border="0" cellpadding="6" width="99%">
    {% for a in final_results %}
        <tr>
            <td width="3%" align="center">
                <input type="checkbox" name="selected_urls" value="{{loop.index0}}" checked onchange="updateCopyArea()">
            </td>
            <td>
                <span id="title_{{loop.index0}}">{{a.title}}</span>
                (<span id="press_{{loop.index0}}">{{a.press}}</span>)
                <br><span style="color:#888; font-size:0.95em;">ğŸ•’ {{a.pubdate_str}}</span>
                <br><span class="small">í‚¤ì›Œë“œ: {{a.matched_str}}</span>
                <span id="url_{{loop.index0}}" style="display:none;">{{a.url}}</span>
            </td>
        </tr>
    {% endfor %}
    </table>
    </form>
    <textarea id="copy_area" class="copytxt" readonly></textarea>
    <div style="margin:12px 0;">
        <button id="shorten_btn" type="button" class="btn" onclick="convertShortUrls()">ì£¼ì†Œë³€í™˜</button>
        <div id="fail_area" style="margin-top:6px; color:#d43f3a;"></div>
    </div>
    {% endif %}
</body>
</html>
