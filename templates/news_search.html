<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>📰 뉴스검색기</title>
    <style>
        body { font-family: "맑은 고딕", "Malgun Gothic", Arial, sans-serif; margin:30px;}
        .btn { margin:3px; padding: 6px 12px; border-radius:6px; border:1px solid #ddd; background:#f3f3f3; cursor:pointer; }
        .article-block { border-bottom:1px solid #eee; margin:10px 0; padding:10px 0; }
        .gray { color:gray; font-size:13px;}
        .textarea { width:100%; min-height:150px;}
    </style>
</head>
<body>
    <h2>📰 뉴스검색기</h2>
    <form method="post" action="/search">
        <label>🔍 키워드 입력 (쉼표로 구분):</label>
        <input type="text" name="keywords" value="{{keywords}}">
        <label>
            <input type="radio" name="search_mode" value="전체" {% if search_mode=="전체" %}checked{% endif %}> 전체
        </label>
        <label>
            <input type="radio" name="search_mode" value="동영상만" {% if search_mode=="동영상만" %}checked{% endif %}> 동영상만
        </label>
        <label>
            <input type="radio" name="search_mode" value="주요언론사만" {% if search_mode=="주요언론사만" %}checked{% endif %}> 주요언론사만
        </label>
        <button class="btn" type="submit">🔍 뉴스 검색</button>
        <span class="gray">🕒 현재 시각: {{now}}</span>
    </form>
    {% if debug_msgs %}
        <div style="color:tomato;">
            {% for msg in debug_msgs %}
                <div>{{msg}}</div>
            {% endfor %}
        </div>
    {% endif %}
    <form id="shorten-form" method="post" action="/shorten">
        <input type="hidden" id="shorten_urls" name="urls">
        <input type="hidden" id="shorten_presses" name="presses">
        <input type="hidden" name="keywords" value="{{keywords}}">
        <input type="hidden" name="search_mode" value="{{search_mode}}">
        <div>
            <button type="button" class="btn" onclick="selectAll(true)">✅ 전체 선택</button>
            <button type="button" class="btn" onclick="selectAll(false)">❌ 전체 해제</button>
            <button type="submit" class="btn">📑 주소 요약하기</button>
        </div>
        {% for a in results %}
        <div class="article-block">
            <label>
                <input type="checkbox" name="selected" value="{{a.url}}" data-press="{{a.press}}" checked>
                <b>{{a.title}}</b> <span class="gray">({{a.press}})</span>
            </label>
            <div class="gray">🕒 {{a.pubdate.strftime('%Y-%m-%d %H:%M')}} | 키워드: {{a.matched|join(', ')}}</div>
            <a href="{{a.url}}" target="_blank">📎 기사 바로보기</a>
        </div>
        {% endfor %}
        <div>
            <textarea class="textarea" id="final_txt" readonly placeholder="최종 결과">{{final_txt}}</textarea>
        </div>
        {% if short_urls %}
            <h3>단축주소 결과</h3>
            <textarea rows="8" style="width:100%;">{{short_urls|join('\n')}}</textarea>
        {% endif %}
    </form>
    <script>
        function selectAll(flag){
            document.querySelectorAll("input[name='selected']").forEach(chk=>chk.checked=flag);
        }
        document.getElementById("shorten-form").onsubmit = function() {
            let urls = [];
            let presses = [];
            document.querySelectorAll("input[name='selected']:checked").forEach(chk=>{
                urls.push(chk.value);
                presses.push(chk.dataset.press);
            });
            document.getElementById('shorten_urls').value = urls.join(',');
            document.getElementById('shorten_presses').value = presses.join(',');
            return true;
        }
    </script>
</body>
</html>
