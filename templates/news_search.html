<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“° ë„¤ì´ë²„ ë‰´ìŠ¤ê²€ìƒ‰ê¸°</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .input-long { width: 100%; font-size: 1.1em; }
        textarea { width: 100%; height: 220px; font-size: 1em; }
        .result-row { margin-bottom: 8px; }
        .toolbar { margin: 1em 0; }
        .btn { padding: 4px 16px; margin-right: 10px; }
        .checkbox-list { margin-bottom: 1em; }
    </style>
    <script>
        // ê²°ê³¼ ì„ íƒ/í•´ì œ/ë³µì‚¬/ì£¼ì†Œë³€í™˜ JS
        function toggleAll(check) {
            document.querySelectorAll('.row-checkbox').forEach(e => {e.checked = check;});
            updateText();
        }
        function updateText() {
            let lines = [];
            document.querySelectorAll('.row-checkbox').forEach((cb, i) => {
                if (cb.checked) {
                    let line = document.getElementById('resultline_' + i).innerText;
                    lines.push(line);
                }
            });
            document.getElementById('final_textarea').value = lines.join('\n\n');
        }
        async function copySelected() {
            updateText();
            const text = document.getElementById('final_textarea').value;
            await navigator.clipboard.writeText(text);
            alert('ë³µì‚¬ë¨!');
        }
        async function shortenUrls() {
            let urls = [];
            document.querySelectorAll('.row-checkbox').forEach((cb, i) => {
                if (cb.checked) {
                    let url = cb.value;
                    urls.push(url);
                }
            });
            if (urls.length == 0) return;
            document.getElementById('shortenBtn').innerText = "ì£¼ì†Œë³€í™˜ì¤‘...";
            const resp = await fetch('/shorten', {
                method: 'POST',
                body: new URLSearchParams(urls.map(u => ['urls', u]))
            });
            const data = await resp.json();
            document.querySelectorAll('.row-checkbox').forEach((cb, i) => {
                if (cb.checked) {
                    let line = document.getElementById('resultline_' + i).innerText;
                    let old_url = cb.value;
                    let new_url = data.shortened.shift();
                    line = line.replace(old_url, new_url);
                    document.getElementById('resultline_' + i).innerText = line;
                }
            });
            updateText();
            document.getElementById('shortenBtn').innerText = "ì„ íƒ ì£¼ì†Œ ë‹¨ì¶•ë³€í™˜";
        }
    </script>
</head>
<body>
    <h2>ğŸ“° ë„¤ì´ë²„ ë‰´ìŠ¤ê²€ìƒ‰ê¸°</h2>
    <form method="post">
        <input type="hidden" name="search_mode" value="major"/>
        <div>
            <label for="keywords">ğŸ” í‚¤ì›Œë“œ ì…ë ¥ (ì‰¼í‘œ êµ¬ë¶„):</label>
            <input class="input-long" type="text" id="keywords" name="keywords" value="{{request.form.keywords if request.method=='POST' else default_keywords}}" placeholder="{{default_keywords}}" />
        </div>
        <div class="checkbox-list">
            <label><input type="checkbox" name="checked_two_keywords" {% if checked_two_keywords %}checked{% endif %}> 2ê°œ ì´ìƒ í‚¤ì›Œë“œ í¬í•¨ ê¸°ì‚¬ë§Œ ë³´ê¸°</label>
        </div>
        <button class="btn" type="submit">ğŸ” ë‰´ìŠ¤ ê²€ìƒ‰</button>
    </form>

    {% if msg %}
        <div style="margin-top:1em; color:#777;">{{msg}}</div>
    {% endif %}

    {% if final_results %}
    <div class="toolbar">
        <button class="btn" type="button" onclick="toggleAll(true)">âœ… ì „ì²´ ì„ íƒ</button>
        <button class="btn" type="button" onclick="toggleAll(false)">âŒ ì „ì²´ í•´ì œ</button>
        <button class="btn" type="button" onclick="copySelected()">ğŸ“‹ ì„ íƒ ë³µì‚¬</button>
    </div>
    <div>
        {% for row in final_results %}
        <div class="result-row">
            <input class="row-checkbox" type="checkbox" value="{{row.url}}" checked onchange="updateText()"/>
            <span id="resultline_{{loop.index0}}">
                â–  {{row.title}} ({{row.press}}) | {{row.pubdate.strftime('%Y-%m-%d %H:%M')}} | í‚¤ì›Œë“œ: {{row.matched|join(', ')}}<br>
                {{row.url}}
            </span>
        </div>
        {% endfor %}
    </div>
    <textarea id="final_textarea" readonly>
{% for row in final_results %}
â–  {{row.title}} ({{row.press}}) | {{row.pubdate.strftime('%Y-%m-%d %H:%M')}} | í‚¤ì›Œë“œ: {{row.matched|join(', ')}}
{{row.url}}
{% endfor %}
    </textarea>
    <div>
        <button class="btn" id="shortenBtn" type="button" onclick="shortenUrls()">ì„ íƒ ì£¼ì†Œ ë‹¨ì¶•ë³€í™˜</button>
    </div>
    {% endif %}
</body>
</html>
