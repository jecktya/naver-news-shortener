<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>뉴스검색기</title>
    <style>
        textarea { width: 100%; min-height: 200px; }
        .article-item { margin-bottom: 10px; border-bottom:1px solid #eee; padding: 5px;}
        .btn { padding: 6px 10px; margin:2px; }
    </style>
</head>
<body>
    <h2>📰 뉴스검색기</h2>
    <form method="post" action="/search">
        <input type="text" name="input_keywords" value="{{def_keywords}}">
        <select name="search_mode">
            <option value="전체" {% if search_mode=="전체" %}selected{% endif %}>전체</option>
            <option value="주요언론사만" {% if search_mode=="주요언론사만" %}selected{% endif %}>주요언론사만</option>
        </select>
        <button type="submit" class="btn">🔍 뉴스 검색</button>
    </form>
    <br>
    {% if articles %}
    <form method="post" action="/shorten" id="copyForm">
        <button type="button" class="btn" onclick="selectAll(true)">✅ 전체 선택</button>
        <button type="button" class="btn" onclick="selectAll(false)">❌ 전체 해제</button>
        <button type="button" class="btn" onclick="copySelected()">📋 선택 복사</button>
        <button type="submit" class="btn">주소변환하기</button>
        <div id="articleList">
        {% for a in articles %}
        <div class="article-item">
            <input type="checkbox" name="selected" value="{{a.url}}" data-title="{{a.title}}" data-press="{{a.press}}" checked>
            <b>{{a.title}}</b> ({{a.press}})
            <div style="color:gray;font-size:12px;">🕒 {{a.pubdate.strftime('%Y-%m-%d %H:%M')}} | 키워드: {{a.matched|join(', ')}}</div>
            <a href="{{a.url}}" target="_blank">[기사 보기]</a>
        </div>
        {% endfor %}
        </div>
        <input type="hidden" name="selected_keys" id="selected_keys">
        <input type="hidden" name="titles" id="titles">
        <input type="hidden" name="presses" id="presses">
        <textarea id="final_txt"></textarea>
    </form>
    <script>
        function updateTextarea() {
            let out = [], urls=[], titles=[], presses=[];
            document.querySelectorAll("input[name='selected']:checked").forEach(chk=>{
                let title = chk.dataset.title || chk.value;
                let press = chk.dataset.press || '';
                out.push("■ " + title + " (" + press + ")\n" + chk.value);
                urls.push(chk.value);
                titles.push(title);
                presses.push(press);
            });
            document.getElementById('final_txt').value = out.join('\n\n');
            document.getElementById('selected_keys').value = urls.join('\n');
            document.getElementById('titles').value = titles.join('\n');
            document.getElementById('presses').value = presses.join('\n');
        }
        document.querySelectorAll("input[name='selected']").forEach(chk=>{
            chk.addEventListener('change', updateTextarea);
        });
        function selectAll(flag){
            document.querySelectorAll("input[name='selected']").forEach(chk=>{
                chk.checked=flag;
            });
            updateTextarea();
        }
        function copySelected() {
            updateTextarea();
            document.getElementById('final_txt').select();
            document.execCommand('copy');
            alert("복사되었습니다.");
        }
        updateTextarea();
    </script>
    {% endif %}
</body>
</html>
